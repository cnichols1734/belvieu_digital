{% extends "base.html" %}

{% block title %}{{ ticket.subject }} — {{ g.site.display_name or g.workspace.name }}{% endblock %}

{% block content %}
<a href="{{ url_for('portal.ticket_list', site_slug=g.site.site_slug) }}" class="back-link">
    <svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M17 10a.75.75 0 01-.75.75H5.612l4.158 3.96a.75.75 0 11-1.04 1.08l-5.5-5.25a.75.75 0 010-1.08l5.5-5.25a.75.75 0 111.04 1.08L5.612 9.25H16.25A.75.75 0 0117 10z" clip-rule="evenodd"/></svg>
    Back to tickets
</a>

{# ── Ticket Header ── #}
<div class="ticket-header">
    <div class="ticket-header-top">
        <h1 class="ticket-title">{{ ticket.subject }}</h1>
        <div class="ticket-badges">
            {% if ticket.status == 'open' %}
                <span class="badge badge-open"><span class="badge-dot"></span> Open</span>
            {% elif ticket.status == 'in_progress' %}
                <span class="badge badge-in-progress"><span class="badge-dot"></span> In Progress</span>
            {% elif ticket.status == 'waiting_on_client' %}
                <span class="badge badge-waiting"><span class="badge-dot"></span> Waiting on You</span>
            {% elif ticket.status == 'done' %}
                <span class="badge badge-done"><span class="badge-dot"></span> Done</span>
            {% endif %}

            {% if ticket.priority == 'high' %}
                <span class="badge badge-canceled"><span class="badge-dot"></span> High</span>
            {% elif ticket.priority == 'normal' %}
                <span class="badge badge-trialing"><span class="badge-dot"></span> Normal</span>
            {% else %}
                <span class="badge badge-paused"><span class="badge-dot"></span> Low</span>
            {% endif %}
        </div>
    </div>
    <div class="ticket-meta">
        {% if ticket.category %}
            <span>{{ ticket.category|replace('_', ' ')|capitalize }}</span>
            <span class="ticket-meta-sep">&middot;</span>
        {% endif %}
        <span>Opened {{ ticket.created_at.strftime('%b %d, %Y at %I:%M %p') if ticket.created_at else '' }}</span>
        {% if ticket.last_activity_at and ticket.last_activity_at != ticket.created_at %}
            <span class="ticket-meta-sep">&middot;</span>
            <span>Last activity {{ ticket.last_activity_at.strftime('%b %d, %Y') }}</span>
        {% endif %}
    </div>
</div>

{# ── Original Description ── #}
<div class="ticket-thread">
    <div class="ticket-message ticket-message-client">
        <div class="ticket-message-header">
            <div class="ticket-message-avatar">
                {{ (ticket.author.full_name or ticket.author.email)[0]|upper }}
            </div>
            <div>
                <span class="ticket-message-author">{{ ticket.author.full_name or ticket.author.email }}</span>
                <span class="ticket-message-time">
                    {{ ticket.created_at.strftime('%b %d, %Y at %I:%M %p') if ticket.created_at else '' }}
                </span>
            </div>
        </div>
        <div class="ticket-message-body">
            {{ ticket.description }}
        </div>
    </div>

    {# ── Thread Messages ── #}
    {% for msg in messages %}
    <div class="ticket-message {% if msg.author.is_admin %}ticket-message-admin{% else %}ticket-message-client{% endif %}">
        <div class="ticket-message-header">
            <div class="ticket-message-avatar {% if msg.author.is_admin %}ticket-message-avatar-admin{% endif %}">
                {{ (msg.author.full_name or msg.author.email)[0]|upper }}
            </div>
            <div>
                <span class="ticket-message-author">
                    {{ msg.author.full_name or msg.author.email }}
                    {% if msg.author.is_admin %}
                        <span class="badge badge-demo" style="font-size:9px; padding:0.1rem 0.4rem; margin-left:0.25rem;">Support</span>
                    {% endif %}
                </span>
                <span class="ticket-message-time">
                    {{ msg.created_at.strftime('%b %d, %Y at %I:%M %p') if msg.created_at else '' }}
                </span>
            </div>
        </div>
        {% if msg.message != '(attached files)' %}
        <div class="ticket-message-body">
            {{ msg.message }}
        </div>
        {% endif %}
        {% if msg.attachments %}
        <div class="ticket-attachments">
            {% for att in msg.attachments %}
                {% if att.is_image %}
                <a href="{{ att.public_url }}" target="_blank" class="ticket-attachment-img">
                    <img src="{{ att.public_url }}" alt="{{ att.filename }}" loading="lazy">
                </a>
                {% else %}
                <a href="{{ att.public_url }}" target="_blank" class="ticket-attachment-file">
                    <svg class="ticket-attachment-file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/>
                    </svg>
                    <div>
                        <span class="ticket-attachment-name">{{ att.filename }}</span>
                        <span class="ticket-attachment-size">{{ att.human_size }}</span>
                    </div>
                </a>
                {% endif %}
            {% endfor %}
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>

{# ── Reply Form ── #}
{% if g.access_level == 'full' and ticket.status != 'done' %}
<div class="ticket-reply">
    <form method="POST" action="{{ url_for('portal.ticket_reply', site_slug=g.site.site_slug, ticket_id=ticket.id) }}" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="form-group" style="margin-bottom: 0.75rem;">
            <label for="message">Reply</label>
            <textarea id="message" name="message" class="form-control"
                      placeholder="Type your reply..."
                      rows="4"></textarea>
        </div>
        <div class="form-group" style="margin-bottom: 0.75rem;">
            <div class="file-upload-zone file-upload-zone-compact" id="replyUploadZone">
                <input type="file" id="attachments" name="attachments" multiple
                       accept="image/*,.pdf" class="file-upload-input">
                <div class="file-upload-content">
                    <svg class="file-upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:18px;height:18px;">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-7.81 7.81a1.5 1.5 0 002.112 2.13"/>
                    </svg>
                    <span class="file-upload-text">Attach files</span>
                </div>
                <div class="file-upload-preview" id="replyFilePreview"></div>
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Send reply</button>
    </form>
</div>
{% elif ticket.status == 'done' %}
<div class="ticket-reply-closed">
    <p>This ticket has been resolved. If you need further help, please create a new ticket.</p>
    <a href="{{ url_for('portal.ticket_new', site_slug=g.site.site_slug) }}" class="btn btn-secondary btn-sm">New ticket</a>
</div>
{% elif g.access_level != 'full' %}
<div class="ticket-reply-closed">
    <p>An active subscription is required to reply to tickets.</p>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
(function() {
    // Lightbox for images
    document.querySelectorAll('.ticket-attachment-img').forEach(function(link) {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const overlay = document.createElement('div');
            overlay.className = 'lightbox-overlay';
            const close = document.createElement('button');
            close.className = 'lightbox-close';
            close.innerHTML = '&times;';
            const img = document.createElement('img');
            img.src = this.href;
            img.alt = this.querySelector('img').alt;
            overlay.appendChild(close);
            overlay.appendChild(img);
            document.body.appendChild(overlay);
            document.body.style.overflow = 'hidden';
            function closeLightbox() { overlay.remove(); document.body.style.overflow = ''; }
            overlay.addEventListener('click', closeLightbox);
            close.addEventListener('click', closeLightbox);
            document.addEventListener('keydown', function esc(ev) {
                if (ev.key === 'Escape') { closeLightbox(); document.removeEventListener('keydown', esc); }
            });
        });
    });

    // File upload preview
    function initUploadZone(zoneId, previewId) {
        const zone = document.getElementById(zoneId);
        if (!zone) return;
        const input = zone.querySelector('.file-upload-input');
        const preview = document.getElementById(previewId);
        let selectedFiles = new DataTransfer();
        function updatePreview() {
            preview.innerHTML = '';
            for (let i = 0; i < selectedFiles.files.length; i++) {
                const file = selectedFiles.files[i];
                const item = document.createElement('div');
                item.className = 'file-preview-item';
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    item.appendChild(img);
                }
                const name = document.createElement('span');
                name.textContent = file.name.length > 25 ? file.name.substring(0, 22) + '...' : file.name;
                item.appendChild(name);
                const remove = document.createElement('button');
                remove.type = 'button';
                remove.className = 'file-preview-remove';
                remove.textContent = '\u00d7';
                remove.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const dt = new DataTransfer();
                    for (let j = 0; j < selectedFiles.files.length; j++) {
                        if (j !== i) dt.items.add(selectedFiles.files[j]);
                    }
                    selectedFiles = dt;
                    input.files = selectedFiles.files;
                    updatePreview();
                });
                item.appendChild(remove);
                preview.appendChild(item);
            }
        }
        input.addEventListener('change', function() {
            for (let i = 0; i < this.files.length; i++) selectedFiles.items.add(this.files[i]);
            input.files = selectedFiles.files;
            updatePreview();
        });
        ['dragenter','dragover'].forEach(e => zone.addEventListener(e, function(ev) { ev.preventDefault(); zone.classList.add('dragover'); }));
        ['dragleave','drop'].forEach(e => zone.addEventListener(e, function(ev) { ev.preventDefault(); zone.classList.remove('dragover'); }));
        zone.addEventListener('drop', function(e) {
            for (let i = 0; i < e.dataTransfer.files.length; i++) selectedFiles.items.add(e.dataTransfer.files[i]);
            input.files = selectedFiles.files;
            updatePreview();
        });
    }
    initUploadZone('replyUploadZone', 'replyFilePreview');
})();
</script>
{% endblock %}
