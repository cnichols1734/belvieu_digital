{% extends "base.html" %}

{% block title %}Payment Successful — {{ g.site.display_name or g.workspace.name }}{% endblock %}

{% block content %}
<div class="cta-page">
    <svg class="cta-page-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color: var(--green-500);">
        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>

    <h1>Payment successful!</h1>
    <p>
        Your subscription is being activated. This usually takes just a few seconds.
        You'll be redirected to your dashboard shortly.
    </p>

    <div class="billing-processing" id="processing-indicator">
        <div class="billing-spinner"></div>
        <span class="text-sm text-muted" id="status-text">Setting things up...</span>
    </div>

    <a href="{{ url_for('portal.dashboard', site_slug=g.site.site_slug) }}?from=checkout" class="btn btn-primary btn-lg mt-3" id="dashboard-btn" style="display:none;">
        Go to dashboard
    </a>

    <p class="text-sm text-muted mt-3" id="manual-note" style="display:none;">
        If you're not redirected, click the button above.
    </p>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    var dashboardUrl = "{{ url_for('portal.dashboard', site_slug=g.site.site_slug) }}?from=checkout";
    // Pass the Stripe session_id so the status endpoint can sync directly from Stripe
    var sessionId = new URLSearchParams(window.location.search).get('session_id') || '';
    var checkUrl = "{{ url_for('billing.checkout_status', site_slug=g.site.site_slug) }}" + (sessionId ? '?session_id=' + encodeURIComponent(sessionId) : '');
    var attempts = 0;
    var maxAttempts = 5;

    function checkStatus() {
        attempts++;
        fetch(checkUrl, { credentials: 'same-origin' })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.active) {
                    window.location.href = dashboardUrl;
                } else if (attempts >= maxAttempts) {
                    // 6 seconds total — show manual button
                    document.getElementById('status-text').textContent = 'Almost there — your payment is confirmed.';
                    document.getElementById('dashboard-btn').style.display = '';
                    document.getElementById('manual-note').style.display = '';
                } else {
                    setTimeout(checkStatus, 1000);
                }
            })
            .catch(function() {
                if (attempts >= 2) {
                    window.location.href = dashboardUrl;
                } else {
                    setTimeout(checkStatus, 1000);
                }
            });
    }

    // First poll after 1 second — the fallback fetches from Stripe directly
    setTimeout(checkStatus, 1000);
})();
</script>
{% endblock %}
