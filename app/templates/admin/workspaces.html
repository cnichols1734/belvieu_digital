{% extends "base.html" %}

{% block title %}Workspaces — Belvieu Digital{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-row">
        <div>
            <h1>Workspaces</h1>
            <p>All client workspaces with subscription and invite status.</p>
        </div>
    </div>
</div>

{% if workspace_data %}
<div class="table-container">
    <table class="table">
        <thead>
            <tr>
                <th>Workspace</th>
                <th>Site Slug</th>
                <th>Members</th>
                <th>Edits</th>
                <th>Plan</th>
                <th>Subscription</th>
                <th>Invite</th>
                <th>Created</th>
            </tr>
        </thead>
        <tbody>
            {% for wd in workspace_data %}
            <tr>
                <td>
                    <a href="{{ url_for('admin.workspace_detail', workspace_id=wd.workspace.id) }}" class="table-link">
                        {{ wd.workspace.name }}
                    </a>
                    {% if wd.workspace.prospect_id %}
                        <span class="text-tertiary text-xs" style="margin-left: 0.25rem;">
                            <a href="{{ url_for('admin.prospect_detail', prospect_id=wd.workspace.prospect_id) }}">from prospect</a>
                        </span>
                    {% endif %}
                </td>
                <td>
                    {% if wd.site %}
                        <span class="font-mono text-sm">/{{ wd.site.site_slug }}/</span>
                    {% else %}
                        <span class="text-tertiary">—</span>
                    {% endif %}
                </td>
                <td class="text-sm">
                    {{ wd.member_count }}
                    <span class="text-tertiary">{{ 'user' if wd.member_count == 1 else 'users' }}</span>
                </td>
                <td>
                    {% set eu = edit_usage_map.get(wd.workspace.id, {}) %}
                    {% if eu.get('limit') is not none %}
                        <span class="edit-usage-compact">
                            <span class="font-medium" {% if eu.get('used', 0) >= eu.get('limit', 0) %}style="color: var(--red-600);"{% endif %}>
                                {{ eu.get('used', 0) }}/{{ eu.get('limit') }}
                            </span>
                            <span class="edit-usage-bar-container">
                                <span class="edit-usage-bar" style="width: {{ [eu.get('used', 0) / eu.get('limit', 1) * 100, 100] | min }}%;
                                     {% if eu.get('used', 0) >= eu.get('limit', 0) %}background: var(--red-500);{% endif %}"></span>
                            </span>
                        </span>
                    {% else %}
                        <span class="text-sm">{{ eu.get('used', 0) }}</span>
                        <span class="text-tertiary text-xs">∞</span>
                    {% endif %}
                </td>
                <td>
                    {% if wd.subscription %}
                        <span class="badge badge-{{ wd.subscription.plan or 'demo' }}">
                            {{ (wd.subscription.plan or 'Unknown') | title }}
                        </span>
                    {% else %}
                        <span class="text-tertiary text-sm">No plan</span>
                    {% endif %}
                </td>
                <td>
                    {% if wd.subscription %}
                        <span class="badge badge-{{ wd.subscription.status }}">
                            <span class="badge-dot"></span>
                            {{ wd.subscription.status | replace('_', ' ') | title }}
                        </span>
                        {% if wd.subscription.cancel_at_period_end %}
                            <span class="badge" style="background: #fef3c7; color: #92400e; border: 1px solid #fde68a; margin-left: 4px; font-size: 0.7rem;">
                                Cancelling
                            </span>
                        {% endif %}
                    {% else %}
                        <span class="text-tertiary text-sm">—</span>
                    {% endif %}
                </td>
                <td>
                    {% if wd.latest_invite %}
                        {% if wd.latest_invite.is_used %}
                            <span class="badge badge-done">Used</span>
                        {% elif wd.latest_invite.is_expired %}
                            <span class="badge badge-canceled">Expired</span>
                        {% else %}
                            <span class="badge badge-open">Pending</span>
                        {% endif %}
                    {% else %}
                        <span class="text-tertiary text-sm">—</span>
                    {% endif %}
                </td>
                <td class="text-muted text-sm">
                    {{ wd.workspace.created_at.strftime('%b %d, %Y') if wd.workspace.created_at else '' }}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="empty-state">
    <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M6.75 21v-3.375c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21M3 3h12m-.75 4.5H21m-3.75 3H21m-3.75 3H21" />
    </svg>
    <h3>No workspaces yet</h3>
    <p>Convert a prospect to create your first workspace.</p>
    <a href="{{ url_for('admin.prospect_list') }}" class="btn btn-primary">View Prospects</a>
</div>
{% endif %}
{% endblock %}
