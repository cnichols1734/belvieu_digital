{% extends "base.html" %}

{% block title %}Admin Dashboard — Belvieu Digital{% endblock %}

{% block content %}
{% include 'admin/_nav.html' %}

<div class="page-header">
    <div class="page-header-row">
        <div>
            <h1>Dashboard</h1>
            <p>Pipeline, revenue, and operations at a glance.</p>
        </div>
        <a href="{{ url_for('admin.prospect_new') }}" class="btn btn-primary">+ Add Prospect</a>
    </div>
</div>

{# ── Stats ── #}
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Pipeline</div>
        <div class="stat-value">{{ total_prospects }}</div>
        <div class="stat-detail">Total prospects</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Monthly Revenue</div>
        <div class="stat-value">${{ mrr }}</div>
        <div class="stat-detail">{{ active_count }} active subscriber{{ 's' if active_count != 1 else '' }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Open Tickets</div>
        <div class="stat-value">{{ open_tickets_count }}</div>
        <div class="stat-detail"><a href="{{ url_for('admin.ticket_list', status='open') }}">View open tickets</a></div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Conversion Rate</div>
        <div class="stat-value">{{ conversion_rate }}%</div>
        <div class="stat-detail">Pitched to converted</div>
    </div>
</div>

{# ── Main Content: Pipeline + Attention ── #}
<div class="content-grid">
    {# Left: Pipeline Breakdown #}
    <div class="card">
        <div class="card-header">
            <span>Prospect Pipeline</span>
            <a href="{{ url_for('admin.prospect_list') }}" class="btn btn-sm btn-ghost">View all</a>
        </div>

        {% if total_prospects > 0 %}
        <div style="display: flex; height: 6px; border-radius: 3px; overflow: hidden; margin-bottom: 1.25rem; background: var(--gray-100);">
            {% set stages = [
                ('researching', pipeline_counts.get('researching', 0), 'var(--gray-400)'),
                ('site_built', pipeline_counts.get('site_built', 0), 'var(--blue-500)'),
                ('pitched', pipeline_counts.get('pitched', 0), 'var(--yellow-500)'),
                ('converted', pipeline_counts.get('converted', 0), 'var(--green-500)'),
                ('declined', pipeline_counts.get('declined', 0), 'var(--red-500)')
            ] %}
            {% for name, count, color in stages %}
                {% if count > 0 %}
                <div style="width: {{ (count / total_prospects * 100)|round(1) }}%; background: {{ color }};" title="{{ name|replace('_', ' ')|title }}: {{ count }}"></div>
                {% endif %}
            {% endfor %}
        </div>
        {% endif %}

        <div class="admin-pipeline-list">
            {% for status in ['researching', 'site_built', 'pitched', 'converted', 'declined'] %}
            <a href="{{ url_for('admin.prospect_list', status=status) }}" class="admin-pipeline-row">
                <span>
                    <span class="badge badge-{{ status }}">
                        <span class="badge-dot"></span>
                        {{ status | replace('_', ' ') | title }}
                    </span>
                </span>
                <span class="admin-pipeline-count">{{ pipeline_counts.get(status, 0) }}</span>
            </a>
            {% endfor %}
        </div>
    </div>

    {# Right: Attention + Status #}
    <div>
        {# At-Risk + Cancelling combined #}
        {% if at_risk_data or cancelling_data or pending_invites > 0 %}
        <div class="card mb-2">
            <div class="card-header">Needs Attention</div>

            {% if at_risk_data %}
            <div class="attention-section">
                <div class="attention-label">
                    <svg style="width: 14px; height: 14px; color: var(--red-500);" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                    Past Due <span class="count">{{ at_risk_data|length }}</span>
                </div>
                {% for item in at_risk_data %}
                <div class="attention-item">
                    <a href="{{ url_for('admin.workspace_detail', workspace_id=item.workspace.id) }}">{{ item.workspace.name }}</a>
                    <span class="text-muted text-sm">{{ item.subscription.plan|capitalize if item.subscription.plan else '' }}</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if cancelling_data %}
            <div class="attention-section">
                <div class="attention-label">
                    <svg style="width: 14px; height: 14px; color: var(--yellow-500);" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                    </svg>
                    Cancelling <span class="count">{{ cancelling_data|length }}</span>
                </div>
                {% for item in cancelling_data %}
                <div class="attention-item">
                    <a href="{{ url_for('admin.workspace_detail', workspace_id=item.workspace.id) }}">{{ item.workspace.name }}</a>
                    <span class="text-muted text-sm">Ends {{ item.subscription.current_period_end.strftime('%b %d') if item.subscription.current_period_end else '?' }}</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if pending_invites > 0 %}
            <div class="attention-section">
                <div class="attention-label">
                    Pending Invites <span class="count">{{ pending_invites }}</span>
                </div>
                <p class="text-sm text-muted">{{ pending_invites }} invite{{ 's' if pending_invites != 1 else '' }} waiting to be accepted.</p>
            </div>
            {% endif %}
        </div>
        {% endif %}

        {# MRR Summary #}
        {% if active_count > 0 %}
        <div class="card">
            <div class="card-header">Revenue</div>
            <div class="admin-detail-row">
                <span class="admin-detail-label">MRR</span>
                <span class="font-semibold">${{ mrr }}/mo</span>
            </div>
            <div class="admin-detail-row">
                <span class="admin-detail-label">Subscribers</span>
                <span>{{ active_count }} active</span>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{# ── Recent Activity ── #}
{% if recent_activity %}
<div class="card mt-3">
    <div class="card-header">Recent Activity</div>
    <div class="admin-activity-feed">
        {% for event in recent_activity %}
        <div class="admin-activity-item">
            <div class="admin-activity-action">
                <span class="badge badge-{{ event.action.split('.')[0] }}">{{ event.action }}</span>
            </div>
            <div class="admin-activity-meta">
                {% if event.actor %}
                    <span class="font-medium">{{ event.actor.full_name or event.actor.email }}</span>
                {% else %}
                    <span class="text-muted">System</span>
                {% endif %}
                <span class="text-tertiary">&middot;</span>
                <span class="text-tertiary">{{ event.created_at.strftime('%b %d, %H:%M') if event.created_at else '' }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endblock %}
