{% extends "base.html" %}

{% block title %}{{ workspace.name }} — Belvieu Digital{% endblock %}

{% block content %}
{% include 'admin/_nav.html' %}

{# Breadcrumb #}
<div class="breadcrumb">
    <a href="{{ url_for('admin.workspace_list') }}">Workspaces</a>
    <span class="breadcrumb-sep">/</span>
    <span>{{ workspace.name }}</span>
</div>

<div class="page-header">
    <div class="page-header-row">
        <div>
            <h1>{{ workspace.name }}</h1>
            <p>
                {% if site %}
                    <span class="badge badge-{{ site.status }}">
                        <span class="badge-dot"></span>
                        {{ site.status | title }}
                    </span>
                {% endif %}
                {% if subscription %}
                    <span class="badge badge-{{ subscription.status }}" style="margin-left: 0.25rem;">
                        <span class="badge-dot"></span>
                        {{ subscription.status | replace('_', ' ') | title }}
                    </span>
                {% endif %}
                <span class="text-muted" style="margin-left: 0.5rem;">Created {{ workspace.created_at.strftime('%b %d, %Y') if workspace.created_at else '' }}</span>
            </p>
        </div>
        {% if site and site.published_url %}
        <a href="{{ site.published_url }}" target="_blank" class="btn btn-secondary">
            View Live Site
        </a>
        {% endif %}
    </div>
</div>

{# ── Tab Navigation ── #}
<div class="admin-tabs">
    <button class="admin-tab {{ 'active' if active_tab == 'overview' }}" onclick="switchTab('overview')">Overview</button>
    <button class="admin-tab {{ 'active' if active_tab == 'business' }}" onclick="switchTab('business')">Business Info</button>
    <button class="admin-tab {{ 'active' if active_tab == 'site' }}" onclick="switchTab('site')">Site Settings</button>
    <button class="admin-tab {{ 'active' if active_tab == 'settings' }}" onclick="switchTab('settings')">Settings</button>
    <button class="admin-tab {{ 'active' if active_tab == 'invites' }}" onclick="switchTab('invites')">
        Invites
        {% set pending_count = invites | rejectattr('is_used') | rejectattr('is_expired') | list | length if invites else 0 %}
        {% if pending_count > 0 %}
            <span class="admin-tab-badge">{{ pending_count }}</span>
        {% endif %}
    </button>
</div>

{# ═══════════════════════════════════════════════
   TAB 1: OVERVIEW
   ═══════════════════════════════════════════════ #}
<div class="admin-tab-panel {{ 'active' if active_tab == 'overview' }}" id="tab-overview">
    <div class="content-grid">
        {# Left Column #}
        <div>
            {# Site Info #}
            {% if site %}
            <div class="card mb-2">
                <div class="card-header">
                    <span>Site</span>
                    <span class="badge badge-{{ site.status }}">
                        <span class="badge-dot"></span>
                        {{ site.status | title }}
                    </span>
                </div>

                <div class="admin-detail-row">
                    <span class="admin-detail-label">Slug</span>
                    <span class="font-mono text-sm">/{{ site.site_slug }}/</span>
                </div>
                <div class="admin-detail-row">
                    <span class="admin-detail-label">Display Name</span>
                    <span>{{ site.display_name or '—' }}</span>
                </div>
                <div class="admin-detail-row">
                    <span class="admin-detail-label">Published URL</span>
                    {% if site.published_url %}
                        <a href="{{ site.published_url }}" target="_blank">{{ site.published_url }}</a>
                    {% else %}
                        <span class="text-tertiary">—</span>
                    {% endif %}
                </div>
                <div class="admin-detail-row">
                    <span class="admin-detail-label">Custom Domain</span>
                    {% if site.custom_domain %}
                        <span>{{ site.custom_domain }}</span>
                    {% else %}
                        <button class="btn btn-sm btn-ghost" onclick="switchTab('site')" style="padding: 0; color: var(--color-primary);">+ Add domain</button>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {# Monthly Edit Usage #}
            <div class="card mb-2">
                <div class="card-header">Monthly Edits</div>
                {% if edit_usage.limit is not none %}
                    <div class="edit-usage-bar-container" style="margin-bottom: 0.5rem;">
                        <div class="edit-usage-bar" style="width: {{ [edit_usage.used / edit_usage.limit * 100, 100] | min }}%;
                             {% if edit_usage.used >= edit_usage.limit %}background: var(--red-500);{% endif %}"></div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="font-medium">{{ edit_usage.used }} / {{ edit_usage.limit }}</span>
                        <span class="text-sm text-muted">
                            {% if edit_usage.used >= edit_usage.limit %}
                                <span style="color: var(--red-600);">Allowance reached</span>
                            {% else %}
                                {{ edit_usage.limit - edit_usage.used }} remaining
                            {% endif %}
                        </span>
                    </div>
                {% else %}
                    <div class="flex items-center justify-between">
                        <span class="font-medium">{{ edit_usage.used }} edits this month</span>
                        <span class="text-sm text-tertiary">Unlimited</span>
                    </div>
                {% endif %}
                <div class="form-hint" style="margin-top: 0.5rem;">
                    Counts content update tickets marked done this month. Resets on the 1st.
                </div>
            </div>

            {# Members #}
            <div class="card mb-2">
                <div class="card-header">Members ({{ member_data | length }})</div>
                {% for md in member_data %}
                <div class="admin-detail-row" style="padding: 0.625rem 0;">
                    <div>
                        <span class="font-medium">{{ md.user.full_name or md.user.email }}</span>
                        {% if md.user.is_admin %}
                            <span class="badge badge-demo" style="margin-left: 0.25rem;">Admin</span>
                        {% endif %}
                        <br>
                        <span class="text-muted text-sm">{{ md.user.email }}</span>
                    </div>
                    <span class="badge badge-{{ md.member.role }}">{{ md.member.role | title }}</span>
                </div>
                {% else %}
                <p class="text-muted text-sm">No registered users yet. Generate an invite to get started.</p>
                {% endfor %}
            </div>

            {# Recent Tickets #}
            <div class="card">
                <div class="card-header">
                    <span>Recent Tickets</span>
                    <a href="{{ url_for('admin.ticket_list') }}" class="btn btn-sm btn-ghost">View all</a>
                </div>
                {% if tickets %}
                    {% for ticket in tickets %}
                    <a href="{{ url_for('admin.ticket_detail', ticket_id=ticket.id) }}" class="ticket-row-link" style="padding: 0.5rem 0; border-bottom: 1px solid var(--color-border-light);">
                        <div>
                            <span class="ticket-row-subject">{{ ticket.subject }}</span>
                            <div class="ticket-row-meta">{{ ticket.category or 'General' }} &middot; {{ ticket.last_activity_at.strftime('%b %d') if ticket.last_activity_at else '' }}</div>
                        </div>
                        <span class="badge badge-{{ ticket.status | replace('_', '-') }}">
                            <span class="badge-dot"></span>
                            {{ ticket.status | replace('_', ' ') | title }}
                        </span>
                    </a>
                    {% endfor %}
                {% else %}
                    <p class="text-muted text-sm">No tickets yet.</p>
                {% endif %}
            </div>
        </div>

        {# Right Column #}
        <div>
            {# Subscription #}
            <div class="card mb-2">
                <div class="card-header">Subscription</div>
                {% if subscription %}
                    <div class="admin-detail-row">
                        <span class="admin-detail-label">Plan</span>
                        <span class="font-medium">{{ (subscription.plan or 'Unknown') | title }}</span>
                    </div>
                    <div class="admin-detail-row">
                        <span class="admin-detail-label">Status</span>
                        <span class="badge badge-{{ subscription.status }}">
                            <span class="badge-dot"></span>
                            {{ subscription.status | replace('_', ' ') | title }}
                        </span>
                    </div>
                    <div class="admin-detail-row">
                        <span class="admin-detail-label">
                            {% if subscription.cancel_at_period_end %}Cancels{% else %}Renewal{% endif %}
                        </span>
                        <span>{{ subscription.current_period_end.strftime('%b %d, %Y') if subscription.current_period_end else '—' }}</span>
                    </div>
                    {% if subscription.cancel_at_period_end %}
                    <div class="alert alert-warning" style="margin-top: 0.75rem; margin-bottom: 0;">
                        Client has cancelled. Subscription ends {{ subscription.current_period_end.strftime('%b %d, %Y') if subscription.current_period_end else 'at end of period' }}.
                    </div>
                    {% endif %}
                    {% if subscription.status == 'canceled' %}
                    <div class="alert alert-danger" style="margin-top: 0.75rem; margin-bottom: 0;">
                        Subscription cancelled. Client no longer has an active plan.
                    </div>
                    {% endif %}
                    {% if billing_customer %}
                    <hr class="divider">
                    <a href="https://dashboard.stripe.com/{% if stripe_mode == 'test' %}test/{% endif %}customers/{{ billing_customer.stripe_customer_id }}" target="_blank" class="btn btn-sm btn-secondary btn-full">
                        Open in Stripe
                    </a>
                    {% endif %}
                {% else %}
                    <p class="text-muted text-sm">No subscription yet.</p>
                {% endif %}
            </div>

            {# Domain Request #}
            {% if site %}
            <div class="card mb-2">
                <div class="card-header">
                    <span>Domain</span>
                    {% if site.domain_choice %}
                    <span class="text-xs text-muted">{{ site.domain_choice_at.strftime('%b %d, %Y') if site.domain_choice_at else '' }}</span>
                    {% endif %}
                </div>
                {% if site.domain_choice == 'search_new' %}
                    <div class="admin-detail-row">
                        <span class="admin-detail-label">Choice</span>
                        <span class="font-medium">Search New Domain</span>
                    </div>
                    <div class="admin-detail-row">
                        <span class="admin-detail-label">Domain</span>
                        <span class="font-mono text-sm">{{ site.requested_domain or '—' }}</span>
                    </div>
                    {% if site.requested_domain_price %}
                    <div class="admin-detail-row">
                        <span class="admin-detail-label">Est. Price</span>
                        <span>${{ '%.2f' | format(site.requested_domain_price) }}/yr</span>
                    </div>
                    {% endif %}
                    <div class="admin-detail-row">
                        <span class="admin-detail-label">Who Buys</span>
                        {% if site.domain_self_purchase %}
                            <span class="badge badge-past-due"><span class="badge-dot"></span> Client</span>
                        {% else %}
                            <span class="badge badge-active"><span class="badge-dot"></span> We register</span>
                        {% endif %}
                    </div>
                    <div class="admin-detail-row">
                        <span class="admin-detail-label">Status</span>
                        {% if site.custom_domain %}
                            <span class="badge badge-active"><span class="badge-dot"></span> Connected</span>
                        {% else %}
                            <span class="badge badge-demo"><span class="badge-dot"></span> Pending Setup</span>
                        {% endif %}
                    </div>
                {% elif site.domain_choice == 'own_domain' %}
                    <div class="admin-detail-row">
                        <span class="admin-detail-label">Choice</span>
                        <span class="font-medium">Client Has Own Domain</span>
                    </div>
                    <div class="admin-detail-row">
                        <span class="admin-detail-label">Domain</span>
                        <span class="font-mono text-sm">{{ site.requested_domain or '—' }}</span>
                    </div>
                    <div class="admin-detail-row">
                        <span class="admin-detail-label">Status</span>
                        {% if site.custom_domain %}
                            <span class="badge badge-active"><span class="badge-dot"></span> Connected</span>
                        {% else %}
                            <span class="badge badge-demo"><span class="badge-dot"></span> Pending DNS</span>
                        {% endif %}
                    </div>
                {% elif site.domain_choice == 'keep_subdomain' %}
                    <div class="admin-detail-row">
                        <span class="admin-detail-label">Choice</span>
                        <span class="font-medium">Keep Subdomain</span>
                    </div>
                    <div class="admin-detail-row">
                        <span class="admin-detail-label">Note</span>
                        <span class="text-sm text-muted">No custom domain needed</span>
                    </div>
                {% else %}
                    <p class="text-muted text-sm">Client hasn't selected a domain option yet.</p>
                {% endif %}
            </div>
            {% endif %}

            {# Business Snapshot #}
            {% if prospect %}
            <div class="card mb-2">
                <div class="card-header">
                    <span>Business</span>
                    <button class="btn btn-sm btn-ghost" onclick="switchTab('business')">Edit</button>
                </div>
                <div class="admin-detail-row">
                    <span class="admin-detail-label">Contact</span>
                    <span>{{ prospect.contact_name or '—' }}</span>
                </div>
                {% if prospect.contact_email %}
                <div class="admin-detail-row">
                    <span class="admin-detail-label">Email</span>
                    <span class="text-sm">{{ prospect.contact_email }}</span>
                </div>
                {% endif %}
                {% if prospect.contact_phone %}
                <div class="admin-detail-row">
                    <span class="admin-detail-label">Phone</span>
                    <span class="text-sm">{{ prospect.contact_phone }}</span>
                </div>
                {% endif %}
                <div class="admin-detail-row">
                    <span class="admin-detail-label">Source</span>
                    <span class="badge badge-{{ prospect.source }}">{{ prospect.source | replace('_', ' ') | title }}</span>
                </div>
            </div>
            {% endif %}

            {# Settings Snapshot #}
            {% if settings %}
            <div class="card">
                <div class="card-header">
                    <span>Settings</span>
                    <button class="btn btn-sm btn-ghost" onclick="switchTab('settings')">Edit</button>
                </div>
                <div class="admin-detail-row">
                    <span class="admin-detail-label">Brand Color</span>
                    <span>
                        {% if settings.brand_color %}
                            <span style="display:inline-block;width:14px;height:14px;border-radius:3px;background:{{ settings.brand_color }};vertical-align:middle;margin-right:0.25rem;border:1px solid var(--color-border);"></span>
                            {{ settings.brand_color }}
                        {% else %}
                            <span class="text-tertiary">—</span>
                        {% endif %}
                    </span>
                </div>
                <div class="admin-detail-row">
                    <span class="admin-detail-label">Allowance</span>
                    <span>{{ settings.update_allowance if settings.update_allowance is not none else 'Unlimited' }}/mo</span>
                </div>
                <div class="admin-detail-row">
                    <span class="admin-detail-label">Support</span>
                    <span>{{ (settings.plan_features or {}).get('support_priority', 'normal') | title }}</span>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{# ═══════════════════════════════════════════════
   TAB 2: BUSINESS INFO
   ═══════════════════════════════════════════════ #}
<div class="admin-tab-panel {{ 'active' if active_tab == 'business' }}" id="tab-business">
    {% if prospect %}
    <div style="max-width: 720px;">
        {# View Mode #}
        <div class="card" id="business-view">
            <div class="card-header">
                <span>Business Details</span>
                <button class="btn btn-sm btn-secondary" onclick="toggleBusinessEdit(true)">Edit</button>
            </div>

            <div class="admin-detail-row">
                <span class="admin-detail-label">Business Name</span>
                <span class="font-medium">{{ prospect.business_name }}</span>
            </div>
            <div class="admin-detail-row">
                <span class="admin-detail-label">Contact Name</span>
                <span>{{ prospect.contact_name or '—' }}</span>
            </div>
            <div class="admin-detail-row">
                <span class="admin-detail-label">Contact Email</span>
                <span>{{ prospect.contact_email or '—' }}</span>
            </div>
            <div class="admin-detail-row">
                <span class="admin-detail-label">Contact Phone</span>
                <span>{{ prospect.contact_phone or '—' }}</span>
            </div>

            <hr class="divider">

            <div class="admin-detail-row">
                <span class="admin-detail-label">Source</span>
                <span class="badge badge-{{ prospect.source }}">{{ prospect.source | replace('_', ' ') | title }}</span>
            </div>
            <div class="admin-detail-row">
                <span class="admin-detail-label">Source URL</span>
                {% if prospect.source_url %}
                    <a href="{{ prospect.source_url }}" target="_blank">{{ prospect.source_url }}</a>
                {% else %}
                    <span class="text-tertiary">—</span>
                {% endif %}
            </div>
            <div class="admin-detail-row">
                <span class="admin-detail-label">Demo URL</span>
                {% if prospect.demo_url %}
                    <a href="{{ prospect.demo_url }}" target="_blank">{{ prospect.demo_url }}</a>
                {% else %}
                    <span class="text-tertiary">—</span>
                {% endif %}
            </div>

            <hr class="divider">

            <div class="admin-detail-row">
                <span class="admin-detail-label">Pipeline Status</span>
                <span class="badge badge-{{ prospect.status }}">
                    <span class="badge-dot"></span>
                    {{ prospect.status | replace('_', ' ') | title }}
                </span>
            </div>
            {% if prospect.notes %}
            <div style="padding-top: 0.75rem;">
                <span class="admin-detail-label" style="display: block; margin-bottom: 0.25rem;">Notes</span>
                <p class="text-sm" style="white-space: pre-wrap; color: var(--color-text-secondary);">{{ prospect.notes }}</p>
            </div>
            {% endif %}
        </div>

        {# Edit Mode #}
        <div class="card" id="business-edit" style="display: none;">
            <div class="card-header">
                <span>Edit Business Details</span>
                <button class="btn btn-sm btn-ghost" onclick="toggleBusinessEdit(false)">Cancel</button>
            </div>

            <form method="POST" action="{{ url_for('admin.workspace_prospect_update', workspace_id=workspace.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="form-group">
                    <label for="business_name">Business Name</label>
                    <input type="text" id="business_name" name="business_name" class="form-control"
                           value="{{ prospect.business_name }}" required>
                </div>

                <div class="content-grid">
                    <div class="form-group">
                        <label for="contact_name">Contact Name</label>
                        <input type="text" id="contact_name" name="contact_name" class="form-control"
                               value="{{ prospect.contact_name or '' }}">
                    </div>
                    <div class="form-group">
                        <label for="contact_email">Contact Email</label>
                        <input type="email" id="contact_email" name="contact_email" class="form-control"
                               value="{{ prospect.contact_email or '' }}">
                    </div>
                </div>

                <div class="content-grid">
                    <div class="form-group">
                        <label for="contact_phone">Contact Phone</label>
                        <input type="text" id="contact_phone" name="contact_phone" class="form-control"
                               value="{{ prospect.contact_phone or '' }}">
                    </div>
                    <div class="form-group">
                        <label for="source">Source</label>
                        <select id="source" name="source" class="form-control">
                            <option value="google_maps" {{ 'selected' if prospect.source == 'google_maps' }}>Google Maps</option>
                            <option value="facebook" {{ 'selected' if prospect.source == 'facebook' }}>Facebook</option>
                            <option value="yelp" {{ 'selected' if prospect.source == 'yelp' }}>Yelp</option>
                            <option value="referral" {{ 'selected' if prospect.source == 'referral' }}>Referral</option>
                            <option value="other" {{ 'selected' if prospect.source == 'other' }}>Other</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="source_url">Source URL</label>
                    <input type="url" id="source_url" name="source_url" class="form-control"
                           value="{{ prospect.source_url or '' }}"
                           placeholder="Link to Google Maps or Facebook listing">
                </div>

                <div class="form-group">
                    <label for="demo_url">Demo URL</label>
                    <input type="url" id="demo_url" name="demo_url" class="form-control"
                           value="{{ prospect.demo_url or '' }}"
                           placeholder="e.g. https://business.yourdomain.dev">
                </div>

                <div class="form-group">
                    <label for="notes">Notes</label>
                    <textarea id="notes" name="notes" class="form-control" rows="4">{{ prospect.notes or '' }}</textarea>
                </div>

                <div class="flex gap-1">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" class="btn btn-ghost" onclick="toggleBusinessEdit(false)">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    {% else %}
    <div class="card" style="max-width: 720px;">
        <div class="card-header">Business Info</div>
        <p class="text-muted text-sm">This workspace was not created from a prospect record.</p>
    </div>
    {% endif %}
</div>

{# ═══════════════════════════════════════════════
   TAB 3: SITE SETTINGS
   ═══════════════════════════════════════════════ #}
<div class="admin-tab-panel {{ 'active' if active_tab == 'site' }}" id="tab-site">
    {% if site %}
    <div style="max-width: 720px;">
        <div class="card mb-2">
            <div class="card-header">Site Configuration</div>

            <form method="POST" action="{{ url_for('admin.workspace_site_update', workspace_id=workspace.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="form-group">
                    <label>Site Slug</label>
                    <input type="text" class="form-control" value="/{{ site.site_slug }}/" disabled
                           style="background: var(--gray-50); color: var(--color-text-secondary);">
                    <div class="form-hint">The URL path cannot be changed after creation</div>
                </div>

                <div class="form-group">
                    <label for="display_name">Display Name</label>
                    <input type="text" id="display_name" name="display_name" class="form-control"
                           value="{{ site.display_name or '' }}"
                           placeholder="e.g. Mario's Pizza">
                </div>

                <div class="form-group">
                    <label for="published_url">Published URL</label>
                    <input type="url" id="published_url" name="published_url" class="form-control"
                           value="{{ site.published_url or '' }}"
                           placeholder="e.g. https://business.yourdomain.dev">
                </div>

                {% if site.domain_choice and site.requested_domain %}
                <div class="alert alert-info" style="margin-bottom: 1rem;">
                    <svg class="alert-icon" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                    <div>
                        <strong>Client Requested:</strong>
                        <span class="font-mono">{{ site.requested_domain }}</span>
                        {% if site.domain_choice == 'search_new' %}
                            {% if site.domain_self_purchase %}
                                &mdash; client will purchase
                            {% else %}
                                &mdash; included, we register{% if site.requested_domain_price %} (${{ '%.2f' | format(site.requested_domain_price) }}/yr){% endif %}
                            {% endif %}
                        {% elif site.domain_choice == 'own_domain' %}
                            &mdash; client owns, help with DNS
                        {% endif %}
                    </div>
                </div>
                {% elif site.domain_choice == 'keep_subdomain' %}
                <div class="alert alert-info" style="margin-bottom: 1rem;">
                    <svg class="alert-icon" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                    <div><strong>Client Requested:</strong> Keep subdomain URL (no custom domain)</div>
                </div>
                {% endif %}

                <div class="form-group">
                    <label for="custom_domain">Custom Domain</label>
                    <input type="text" id="custom_domain" name="custom_domain" class="form-control"
                           value="{{ site.custom_domain or '' }}"
                           placeholder="e.g. mariospizza.com">
                    <div class="form-hint">Set here once DNS is pointed.</div>
                </div>

                <button type="submit" class="btn btn-primary">Save Site Settings</button>
            </form>
        </div>

        <div class="card">
            <div class="card-header">
                <span>Site Status Override</span>
                <span class="badge badge-{{ site.status }}">
                    <span class="badge-dot"></span>
                    {{ site.status | title }}
                </span>
            </div>
            <p class="text-sm text-muted" style="margin-bottom: 0.75rem;">
                Presentation-only value. Billing controls actual access.
            </p>
            <form method="POST" action="{{ url_for('admin.site_status_override', site_id=site.id) }}" class="control-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <select name="status" class="form-control" style="width: auto;">
                    {% for s in ['demo', 'active', 'paused', 'cancelled'] %}
                    <option value="{{ s }}" {{ 'selected' if site.status == s }}>{{ s | title }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-sm btn-secondary">Override</button>
            </form>
        </div>
    </div>
    {% else %}
    <div class="card" style="max-width: 720px;">
        <div class="card-header">Site Settings</div>
        <p class="text-muted text-sm">No site has been created for this workspace yet.</p>
    </div>
    {% endif %}
</div>

{# ═══════════════════════════════════════════════
   TAB 4: SETTINGS
   ═══════════════════════════════════════════════ #}
<div class="admin-tab-panel {{ 'active' if active_tab == 'settings' }}" id="tab-settings">
    <div style="max-width: 720px;">
        <form method="POST" action="{{ url_for('admin.workspace_settings_update', workspace_id=workspace.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="card mb-2">
                <div class="card-header">Branding</div>
                <div class="form-group">
                    <label for="brand_color">Brand Color</label>
                    <div class="flex gap-1 items-center">
                        <input type="color" id="brand_color_picker"
                               value="{{ (settings.brand_color if settings and settings.brand_color) or '#111111' }}"
                               style="width: 40px; height: 36px; padding: 2px; border: 1px solid var(--color-border); border-radius: var(--radius-sm); cursor: pointer;"
                               onchange="document.getElementById('brand_color').value = this.value">
                        <input type="text" id="brand_color" name="brand_color" class="form-control"
                               value="{{ (settings.brand_color if settings and settings.brand_color) or '' }}"
                               placeholder="#000000" style="max-width: 140px;"
                               oninput="try { document.getElementById('brand_color_picker').value = this.value } catch(e) {}">
                    </div>
                    <div class="form-hint">Used for accent color in the client portal. Leave blank for default.</div>
                </div>
            </div>

            <div class="card mb-2">
                <div class="card-header">Service Limits</div>
                <div class="form-group">
                    <label for="update_allowance">Monthly Update Allowance</label>
                    <input type="text" id="update_allowance" name="update_allowance" class="form-control"
                           value="{{ settings.update_allowance if settings and settings.update_allowance is not none else '' }}"
                           placeholder="Unlimited" style="max-width: 200px;">
                    <div class="form-hint">Number of site edits per month. Leave blank for unlimited.</div>
                </div>
                <div class="form-group">
                    <label for="support_priority">Support Priority</label>
                    <select id="support_priority" name="support_priority" class="form-control" style="max-width: 200px;">
                        {% set current_priority = (settings.plan_features or {}).get('support_priority', 'normal') if settings else 'normal' %}
                        <option value="normal" {{ 'selected' if current_priority == 'normal' }}>Normal</option>
                        <option value="priority" {{ 'selected' if current_priority == 'priority' }}>Priority</option>
                    </select>
                </div>
            </div>

            <div class="card mb-2">
                <div class="card-header">Features</div>
                <div class="form-group" style="margin-bottom: 0.75rem;">
                    <label class="check-label">
                        <input type="checkbox" name="contact_form" {{ 'checked' if settings and (settings.plan_features or {}).get('contact_form') }}>
                        <span>Contact Form</span>
                    </label>
                    <div class="form-hint" style="margin-left: 1.5rem;">Enable the contact form on the client's website.</div>
                </div>
                <div class="form-group" style="margin-bottom: 0.75rem;">
                    <label class="check-label">
                        <input type="checkbox" name="analytics_enabled" {{ 'checked' if settings and (settings.plan_features or {}).get('analytics_enabled') }}>
                        <span>Analytics Tracking</span>
                    </label>
                    <div class="form-hint" style="margin-left: 1.5rem;">Track page views and visitor analytics.</div>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="check-label">
                        <input type="checkbox" name="maintenance_mode" {{ 'checked' if settings and (settings.plan_features or {}).get('maintenance_mode') }}>
                        <span>Maintenance Mode</span>
                    </label>
                    <div class="form-hint" style="margin-left: 1.5rem;">Show a maintenance page instead of the live site.</div>
                </div>
            </div>

            <div class="card mb-2">
                <div class="card-header">Client Notifications</div>
                <div class="form-group" style="margin-bottom: 0.75rem;">
                    <label class="check-label">
                        <input type="checkbox" name="notify_ticket_replies" {{ 'checked' if not settings or (settings.notification_prefs or {}).get('ticket_replies', true) }}>
                        <span>Ticket Replies</span>
                    </label>
                    <div class="form-hint" style="margin-left: 1.5rem;">Notify client when an admin replies to their ticket.</div>
                </div>
                <div class="form-group" style="margin-bottom: 0.75rem;">
                    <label class="check-label">
                        <input type="checkbox" name="notify_billing_events" {{ 'checked' if not settings or (settings.notification_prefs or {}).get('billing_events', true) }}>
                        <span>Billing Events</span>
                    </label>
                    <div class="form-hint" style="margin-left: 1.5rem;">Payment confirmations, failed charges, renewals.</div>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="check-label">
                        <input type="checkbox" name="notify_site_updates" {{ 'checked' if not settings or (settings.notification_prefs or {}).get('site_updates', true) }}>
                        <span>Site Updates</span>
                    </label>
                    <div class="form-hint" style="margin-left: 1.5rem;">Notify when changes are deployed.</div>
                </div>
            </div>

            <button type="submit" class="btn btn-primary">Save Settings</button>
        </form>
    </div>
</div>

{# ═══════════════════════════════════════════════
   TAB 5: INVITES
   ═══════════════════════════════════════════════ #}
<div class="admin-tab-panel {{ 'active' if active_tab == 'invites' }}" id="tab-invites">
    <div style="max-width: 720px;">
        <div class="card mb-2">
            <div class="card-header">Generate Invite</div>
            <p class="text-sm text-muted" style="margin-bottom: 0.75rem;">
                Create a new invite link for this client. Expires in 30 days.
            </p>
            <form method="POST" action="{{ url_for('admin.workspace_invite', workspace_id=workspace.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="form-group">
                    <label for="invite_email">Lock to Email (optional)</label>
                    <input type="email" id="invite_email" name="invite_email" class="form-control"
                           placeholder="e.g. client@example.com">
                    <div class="form-hint">If set, only this email address can use the invite link</div>
                </div>
                <button type="submit" class="btn btn-primary">Generate Invite Link</button>
            </form>
        </div>

        <div class="card">
            <div class="card-header">Invite History ({{ invites | length }})</div>
            {% if invites %}
                {% for inv in invites %}
                <div class="admin-detail-row" style="padding: 0.625rem 0;">
                    <div>
                        <span class="font-medium text-sm">
                            {% if inv.email %}{{ inv.email }}{% else %}Open invite (any email){% endif %}
                        </span>
                        <br>
                        <span class="text-tertiary text-xs">
                            Created {{ inv.created_at.strftime('%b %d, %Y at %I:%M %p') if inv.created_at else '' }}
                        </span>
                        {% if inv.used_at %}
                        <br>
                        <span class="text-tertiary text-xs">
                            Used {{ inv.used_at.strftime('%b %d, %Y at %I:%M %p') }}
                        </span>
                        {% endif %}
                    </div>
                    {% if inv.is_used %}
                        <span class="badge badge-done">Used</span>
                    {% elif inv.is_expired %}
                        <span class="badge badge-canceled">Expired</span>
                    {% else %}
                        <span class="badge badge-open">Pending</span>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <p class="text-muted text-sm">No invites generated yet.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function switchTab(tabName) {
    document.querySelectorAll('.admin-tab').forEach(function(btn) {
        btn.classList.remove('active');
    });
    document.querySelectorAll('.admin-tab-panel').forEach(function(panel) {
        panel.classList.remove('active');
    });
    document.getElementById('tab-' + tabName).classList.add('active');
    document.querySelectorAll('.admin-tab').forEach(function(btn) {
        if (btn.getAttribute('onclick') === "switchTab('" + tabName + "')") {
            btn.classList.add('active');
        }
    });
    var url = new URL(window.location);
    url.searchParams.set('tab', tabName);
    history.replaceState(null, '', url);
}

function toggleBusinessEdit(show) {
    document.getElementById('business-view').style.display = show ? 'none' : 'block';
    document.getElementById('business-edit').style.display = show ? 'block' : 'none';
}
</script>
{% endblock %}
