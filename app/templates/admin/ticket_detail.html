{% extends "base.html" %}

{% block title %}{{ ticket.subject }} — Admin — Belvieu Digital{% endblock %}

{% block content %}
<!-- Ticket Header -->
<div class="ticket-header">
    <div class="ticket-header-top">
        <h1 class="ticket-title">{{ ticket.subject }}</h1>
        <div class="ticket-badges">
            <span class="badge badge-{{ ticket.status | replace('_', '-') }}">
                <span class="badge-dot"></span>
                {{ ticket.status | replace('_', ' ') | title }}
            </span>
            <span class="badge badge-{{ ticket.priority }}">{{ ticket.priority | title }}</span>
        </div>
    </div>
    <div class="ticket-meta">
        <a href="{{ url_for('admin.workspace_detail', workspace_id=workspace.id) }}">{{ workspace.name }}</a>
        <span class="ticket-meta-sep">·</span>
        {% if ticket.category %}{{ ticket.category | replace('_', ' ') | title }}<span class="ticket-meta-sep">·</span>{% endif %}
        Opened by {{ ticket.author.full_name or ticket.author.email if ticket.author else 'Unknown' }}
        <span class="ticket-meta-sep">·</span>
        {{ ticket.created_at.strftime('%b %d, %Y %H:%M') if ticket.created_at else '' }}
        {% if ticket.assigned_to %}
            <span class="ticket-meta-sep">·</span>
            Assigned to <span class="font-medium">{{ ticket.assigned_to.full_name or ticket.assigned_to.email }}</span>
        {% endif %}
    </div>
</div>

<div class="content-grid">
    <!-- Thread + Reply (Left) -->
    <div>
        <!-- Original Description -->
        <div class="ticket-thread">
            <div class="ticket-message">
                <div class="ticket-message-header">
                    <div class="ticket-message-avatar">
                        {{ (ticket.author.full_name or ticket.author.email)[0] | upper if ticket.author else '?' }}
                    </div>
                    <div>
                        <span class="ticket-message-author">{{ ticket.author.full_name or ticket.author.email if ticket.author else 'Unknown' }}</span>
                        <span class="ticket-message-time">{{ ticket.created_at.strftime('%b %d, %Y %H:%M') if ticket.created_at else '' }}</span>
                    </div>
                </div>
                <div class="ticket-message-body">{{ ticket.description }}</div>
            </div>

            <!-- Message Thread -->
            {% for msg in messages %}
            <div class="ticket-message {% if msg.author and msg.author.is_admin %}ticket-message-admin{% endif %} {% if msg.is_internal %}ticket-message-internal{% endif %}">
                <div class="ticket-message-header">
                    <div class="ticket-message-avatar {% if msg.author and msg.author.is_admin %}ticket-message-avatar-admin{% endif %}">
                        {{ (msg.author.full_name or msg.author.email)[0] | upper if msg.author else '?' }}
                    </div>
                    <div>
                        <span class="ticket-message-author">
                            {{ msg.author.full_name or msg.author.email if msg.author else 'Unknown' }}
                            {% if msg.author and msg.author.is_admin %}
                                <span class="badge badge-demo" style="margin-left: 0.25rem; font-size: 9px; padding: 0.1rem 0.35rem;">Support</span>
                            {% endif %}
                            {% if msg.is_internal %}
                                <span class="badge" style="background: var(--yellow-50); color: var(--yellow-700); margin-left: 0.25rem; font-size: 9px; padding: 0.1rem 0.35rem;">Internal</span>
                            {% endif %}
                        </span>
                        <span class="ticket-message-time">{{ msg.created_at.strftime('%b %d, %Y %H:%M') if msg.created_at else '' }}</span>
                    </div>
                </div>
                {% if msg.message != '(attached files)' %}
                <div class="ticket-message-body">{{ msg.message }}</div>
                {% endif %}
                {% if msg.attachments %}
                <div class="ticket-attachments">
                    {% for att in msg.attachments %}
                        {% if att.is_image %}
                        <a href="{{ att.public_url }}" target="_blank" class="ticket-attachment-img">
                            <img src="{{ att.public_url }}" alt="{{ att.filename }}" loading="lazy">
                        </a>
                        {% else %}
                        <a href="{{ att.public_url }}" target="_blank" class="ticket-attachment-file">
                            <svg class="ticket-attachment-file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/>
                            </svg>
                            <div>
                                <span class="ticket-attachment-name">{{ att.filename }}</span>
                                <span class="ticket-attachment-size">{{ att.human_size }}</span>
                            </div>
                        </a>
                        {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- Reply Form -->
        {% if ticket.status != 'done' %}
        <div class="ticket-reply">
            <form method="POST" action="{{ url_for('admin.ticket_reply', ticket_id=ticket.id) }}" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="form-group">
                    <label for="message">Reply</label>
                    <textarea id="message" name="message" class="form-control" rows="4"
                              placeholder="Type your reply..."></textarea>
                </div>
                <div class="form-group">
                    <div class="file-upload-zone file-upload-zone-compact" id="adminReplyUploadZone">
                        <input type="file" id="attachments" name="attachments" multiple
                               accept="image/*,.pdf" class="file-upload-input">
                        <div class="file-upload-content">
                            <svg class="file-upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:18px;height:18px;">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-7.81 7.81a1.5 1.5 0 002.112 2.13"/>
                            </svg>
                            <span class="file-upload-text">Attach files</span>
                        </div>
                        <div class="file-upload-preview" id="adminFilePreview"></div>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <label class="check-label">
                        <input type="checkbox" name="is_internal">
                        <span>Internal note (only visible to admins)</span>
                    </label>
                    <button type="submit" class="btn btn-primary">Send Reply</button>
                </div>
            </form>
        </div>
        {% else %}
        <div class="ticket-reply-closed">
            <p>This ticket is marked as done.</p>
        </div>
        {% endif %}
    </div>

    <!-- Controls Sidebar (Right) -->
    <div>
        <!-- Status Control -->
        <div class="card mb-2">
            <div class="card-header">Status</div>
            <form method="POST" action="{{ url_for('admin.ticket_status', ticket_id=ticket.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <select name="status" class="form-control mb-1">
                    {% for s in ['open', 'in_progress', 'waiting_on_client', 'done'] %}
                    <option value="{{ s }}" {{ 'selected' if ticket.status == s }}>
                        {{ s | replace('_', ' ') | title }}
                    </option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-sm btn-secondary btn-full">Update Status</button>
            </form>
        </div>

        <!-- Priority Control -->
        <div class="card mb-2">
            <div class="card-header">Priority</div>
            <div class="admin-detail-row">
                <span class="admin-detail-label">Current</span>
                <span class="badge badge-{{ ticket.priority }}">{{ ticket.priority | title }}</span>
            </div>
        </div>

        <!-- Assignment Control -->
        <div class="card mb-2">
            <div class="card-header">Assignment</div>
            <form method="POST" action="{{ url_for('admin.ticket_assign', ticket_id=ticket.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <select name="assigned_to" class="form-control mb-1">
                    <option value="">Unassigned</option>
                    {% for admin in admin_users %}
                    <option value="{{ admin.id }}" {{ 'selected' if ticket.assigned_to_user_id == admin.id }}>
                        {{ admin.full_name or admin.email }}
                    </option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-sm btn-secondary btn-full">Update Assignment</button>
            </form>
        </div>

        <!-- Category Control -->
        <div class="card mb-2">
            <div class="card-header">Category</div>
            <form method="POST" action="{{ url_for('admin.ticket_category', ticket_id=ticket.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <select name="category" class="form-control mb-1">
                    <option value="" {{ 'selected' if not ticket.category }}>General</option>
                    <option value="content_update" {{ 'selected' if ticket.category == 'content_update' }}>Content Update</option>
                    <option value="bug" {{ 'selected' if ticket.category == 'bug' }}>Bug</option>
                    <option value="question" {{ 'selected' if ticket.category == 'question' }}>Question</option>
                </select>
                <button type="submit" class="btn btn-sm btn-secondary btn-full">Update Category</button>
            </form>
            {% if ticket.category == 'content_update' %}
            <div class="form-hint mt-1" style="color: var(--gray-600);">
                This ticket counts toward the monthly edit allowance when marked as done.
            </div>
            {% endif %}
        </div>

        <!-- Monthly Edit Usage -->
        <div class="card mb-2">
            <div class="card-header">Monthly Edits</div>
            <div style="padding: 0.25rem 0;">
                {% if edit_usage.limit is not none %}
                    <div class="edit-usage-bar-container">
                        <div class="edit-usage-bar" style="width: {{ [edit_usage.used / edit_usage.limit * 100, 100] | min }}%;
                             {% if edit_usage.used >= edit_usage.limit %}background: var(--red-500);{% endif %}"></div>
                    </div>
                    <div class="flex items-center justify-between" style="margin-top: 0.375rem;">
                        <span class="text-sm font-medium">{{ edit_usage.used }}/{{ edit_usage.limit }} used</span>
                        <span class="text-xs text-tertiary">
                            {% if edit_usage.used >= edit_usage.limit %}
                                Allowance reached
                            {% else %}
                                {{ edit_usage.limit - edit_usage.used }} remaining
                            {% endif %}
                        </span>
                    </div>
                {% else %}
                    <span class="text-sm">{{ edit_usage.used }} edits</span>
                    <span class="text-tertiary text-xs" style="margin-left: 0.25rem;">· Unlimited</span>
                {% endif %}
            </div>
        </div>

        <!-- Ticket Info -->
        <div class="card">
            <div class="card-header">Details</div>
            <div class="admin-detail-row">
                <span class="admin-detail-label">Site</span>
                {% if site %}
                    <span class="font-mono text-sm">/{{ site.site_slug }}/</span>
                {% else %}
                    <span class="text-tertiary">—</span>
                {% endif %}
            </div>
            <div class="admin-detail-row">
                <span class="admin-detail-label">Created</span>
                <span class="text-sm">{{ ticket.created_at.strftime('%b %d, %Y %H:%M') if ticket.created_at else '' }}</span>
            </div>
            <div class="admin-detail-row">
                <span class="admin-detail-label">Last Activity</span>
                <span class="text-sm">{{ ticket.last_activity_at.strftime('%b %d, %Y %H:%M') if ticket.last_activity_at else '' }}</span>
            </div>
        </div>
    </div>
</div>

<div class="mt-2">
    <a href="{{ url_for('admin.ticket_list') }}" class="btn btn-ghost">← Back to Tickets</a>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    // Lightbox for images
    document.querySelectorAll('.ticket-attachment-img').forEach(function(link) {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const overlay = document.createElement('div');
            overlay.className = 'lightbox-overlay';
            const close = document.createElement('button');
            close.className = 'lightbox-close';
            close.innerHTML = '&times;';
            const img = document.createElement('img');
            img.src = this.href;
            img.alt = this.querySelector('img').alt;
            overlay.appendChild(close);
            overlay.appendChild(img);
            document.body.appendChild(overlay);
            document.body.style.overflow = 'hidden';
            function closeLightbox() { overlay.remove(); document.body.style.overflow = ''; }
            overlay.addEventListener('click', closeLightbox);
            close.addEventListener('click', closeLightbox);
            document.addEventListener('keydown', function esc(ev) {
                if (ev.key === 'Escape') { closeLightbox(); document.removeEventListener('keydown', esc); }
            });
        });
    });

    // File upload preview
    function initUploadZone(zoneId, previewId) {
        const zone = document.getElementById(zoneId);
        if (!zone) return;
        const input = zone.querySelector('.file-upload-input');
        const preview = document.getElementById(previewId);
        let selectedFiles = new DataTransfer();
        function updatePreview() {
            preview.innerHTML = '';
            for (let i = 0; i < selectedFiles.files.length; i++) {
                const file = selectedFiles.files[i];
                const item = document.createElement('div');
                item.className = 'file-preview-item';
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    item.appendChild(img);
                }
                const name = document.createElement('span');
                name.textContent = file.name.length > 25 ? file.name.substring(0, 22) + '...' : file.name;
                item.appendChild(name);
                const remove = document.createElement('button');
                remove.type = 'button';
                remove.className = 'file-preview-remove';
                remove.textContent = '\u00d7';
                remove.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const dt = new DataTransfer();
                    for (let j = 0; j < selectedFiles.files.length; j++) {
                        if (j !== i) dt.items.add(selectedFiles.files[j]);
                    }
                    selectedFiles = dt;
                    input.files = selectedFiles.files;
                    updatePreview();
                });
                item.appendChild(remove);
                preview.appendChild(item);
            }
        }
        input.addEventListener('change', function() {
            for (let i = 0; i < this.files.length; i++) selectedFiles.items.add(this.files[i]);
            input.files = selectedFiles.files;
            updatePreview();
        });
        ['dragenter','dragover'].forEach(e => zone.addEventListener(e, function(ev) { ev.preventDefault(); zone.classList.add('dragover'); }));
        ['dragleave','drop'].forEach(e => zone.addEventListener(e, function(ev) { ev.preventDefault(); zone.classList.remove('dragover'); }));
        zone.addEventListener('drop', function(e) {
            for (let i = 0; i < e.dataTransfer.files.length; i++) selectedFiles.items.add(e.dataTransfer.files[i]);
            input.files = selectedFiles.files;
            updatePreview();
        });
    }
    initUploadZone('adminReplyUploadZone', 'adminFilePreview');
})();
</script>
{% endblock %}
